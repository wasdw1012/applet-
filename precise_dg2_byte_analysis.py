#!/usr/bin/env python3
"""
真实护照 DG2 精确字节分析
详细解析每个字节的含义和数据结构
"""

def precise_byte_analysis():
    print("=" * 100)
    print("真实护照 DG2 精确字节分析")
    print("=" * 100)
    
    print("\n【第一部分：DG2 外层结构】")
    print("-" * 80)
    print("偏移    字节值          说明")
    print("-" * 80)
    print("0x0000: 75              DG2 标签 (Data Group 2)")
    print("0x0001: 82              长度编码：长形式，后续2字节表示长度")
    print("0x0002: 50 6B           长度 = 0x506B = 20,587 字节")
    print("0x0004: 7F 61           生物特征信息组模板标签")
    print("0x0006: 82              长度编码：长形式，后续2字节")
    print("0x0007: 50 66           长度 = 0x5066 = 20,582 字节")
    print("0x0009: 02              样本编号标签")
    print("0x000A: 01              长度 = 1")
    print("0x000B: 01              样本编号 = 1")
    print("0x000C: 7F 60           生物特征信息模板标签")
    print("0x000E: 82              长度编码：长形式")
    print("0x000F: 50 5E           长度 = 0x505E = 20,574 字节")
    
    print("\n【第二部分：生物特征头部模板 (CBEFF)】")
    print("-" * 80)
    print("偏移    字节值          说明")
    print("-" * 80)
    print("0x0011: A1              生物特征头部模板标签")
    print("0x0012: 29              长度 = 41 字节")
    print("0x0013: 80 02 01 00     ICAO头部版本 = v1.0")
    print("0x0017: 81 01 02        生物特征类型 = 02 (面部特征)")
    print("0x001A: 82 01 00        生物特征子类型 = 00 (无特定信息)")
    print("0x001D: 83 07           创建日期时间标签，长度7")
    print("0x001F: 00 00 00 00     日期时间 = 全0 (未设置)")
    print("        00 00 00")
    print("0x0026: 84 08           ※非标准标签 0x84，长度8")
    print("0x0028: 00 00 00 00     8字节全0数据")
    print("        00 00 00 00")
    print("0x0030: 86 02 00 00     创建者 = 0x0000")
    print("0x0034: 87 02 01 01     格式所有者 = 0x0101 (ICAO)")
    print("0x0038: 88 02 00 08     格式类型 = 0x0008 (JPEG2000)")
    
    print("\n【第三部分：生物特征数据块】")
    print("-" * 80)
    print("偏移    字节值          说明")
    print("-" * 80)
    print("0x003C: 5F 2E           生物特征数据块标签")
    print("0x003E: 82              长度编码：长形式")
    print("0x003F: 50 2E           长度 = 0x502E = 20,526 字节")
    
    print("\n【第四部分：FAC 国家自定义头部】")
    print("-" * 80)
    print("偏移    字节值          说明")
    print("-" * 80)
    print("0x0041: 46 41 43 00     'FAC\\0' - Face 人脸数据标识符")
    print("0x0045: 30 31 30 00     '010\\0' - 版本 1.0")
    print("0x0049: 00 00 50 2E     可能是后续数据大小 0x502E")
    print("0x004D: 00 01 00 00     参数标志")
    print("0x0051: 50 20 00 00     未知参数 (可能是缓冲区大小)")
    print("0x0055: 00 00 00 00     保留字段")
    print("0x0059: 00 00 00 00     保留字段")
    print("0x005D: 00 00 00 00     保留字段")
    
    print("\n【第五部分：图像参数区】")
    print("-" * 80)
    print("偏移    字节值          说明")
    print("-" * 80)
    print("0x0061: 00 00 00 01     参数1")
    print("0x0065: 01 62 01 D8     可能是尺寸: 0x162=354, 0x1D8=472")
    print("0x0069: 00 00 00 00     参数")
    print("0x006D: 00 5A           参数")
    print("0x006F: FF 4F           ※JPEG标记：可能是自定义APP标记")
    print("0x0071: FF 51 00 2F     ※JPEG标记：DQT相关")
    print("0x0075: 00 00 00 00     参数")
    print("0x0079: 01 62 00 00     重复的尺寸参数")
    print("0x007D: 01 D8 00 00")
    
    print("\n【第六部分：专有特征数据块】")
    print("-" * 80)
    print("偏移    字节值          说明")
    print("-" * 80)
    
    # FF 52 块
    print("0x00A2: FF 52           ※特征数据块标记1")
    print("0x00A4: 00 0C           长度 = 12 字节")
    print("0x00A6: 00 00 00 01     特征参数")
    print("0x00AA: 01 05 04 04     特征参数")
    print("0x00AE: 00 01           特征参数")
    
    # FF 5C 块
    print("\n0x00B0: FF 5C           ※特征数据块标记2")
    print("0x00B2: 00 13           长度 = 19 字节")
    print("0x00B4: 40 40 48 48     特征数据 (可能是坐标或特征值)")
    print("0x00B8: 50 48 48 50")
    print("0x00BC: 48 48 50 48")
    print("0x00C0: 48 50 48 48")
    print("0x00C4: 50")
    
    # FF 5D 块
    print("\n0x00C5: FF 5D           ※特征数据块标记3")
    print("0x00C7: 00 14           长度 = 20 字节")
    print("0x00C9: 01 40 40 48     索引01 + 特征数据")
    print("        48 50 48 48")
    print("        50 48 48 50")
    print("        48 48 50 48")
    print("        48 50")
    
    print("\n0x00DB: FF 5D           ※特征数据块标记4")
    print("0x00DD: 00 14           长度 = 20 字节")
    print("0x00DF: 02 40 40 48     索引02 + 特征数据")
    print("        ...")
    
    # FF 64 块
    print("\n0x00F1: FF 64           ※扩展数据块")
    print("0x00F3: 00 23           长度 = 35 字节")
    print("0x00F5: 00 00 00 00     35字节的扩展数据（可能是加密参数）")
    print("        ... (31字节)")
    
    # FF 90 块
    print("\n0x0118: FF 90           ※图像参数块")
    print("0x011A: 00 0A           长度 = 10 字节")
    print("0x011C: 00 00 00 00     参数数据")
    print("0x0120: 4F 57 00 01     可能包含实际图像尺寸")
    
    # FF 93 块
    print("\n0x0124: FF 93           ※大型特征向量块")
    print("0x0126: DF 7D           长度标记（特殊编码）")
    print("0x0128: 7C 02 D8        实际长度计算: 约19KB的特征数据")
    print("0x012B: [特征向量数据]  包含深度学习特征向量")
    
    print("\n【第七部分：JPEG 图像数据】")
    print("-" * 80)
    print("偏移    字节值          说明")
    print("-" * 80)
    print("~0x4D00: FF D8 FF       JPEG 文件开始标记 (SOI + 标记)")
    print("        [JPEG数据]      压缩的面部图像")
    print("~0x506D: FF D9           JPEG 文件结束标记 (EOI)")
    
    print("\n【数据结构总结】")
    print("-" * 80)
    print("1. 标准 ICAO 结构 (0x00-0x3F): 符合 ICAO 9303 标准")
    print("2. FAC 头部 (0x40-0x60): 中国特有的人脸数据格式标识")
    print("3. 专有特征区 (0x61-0x4CFF): 包含多种特征数据")
    print("   - FF 4F/51: JPEG相关参数")
    print("   - FF 52: 基础特征参数")
    print("   - FF 5C/5D: 多组特征点数据（可能是不同角度）")
    print("   - FF 64: 扩展/加密参数")
    print("   - FF 90: 图像实际参数")
    print("   - FF 93: AI特征向量（最大数据块）")
    print("4. JPEG 图像 (0x4D00-0x506D): 标准JPEG格式的面部照片")
    
    print("\n【关键发现】")
    print("-" * 80)
    print("• 标签 0x84 是非ICAO标准，可能是中国特有扩展")
    print("• FAC 格式包含版本控制，当前为 1.0")
    print("• FF 系列标签完全是专有格式，用于高级人脸识别")
    print("• 特征数据占用空间远大于实际图像")
    print("• 数据结构支持多重验证和防伪")

if __name__ == "__main__":
    precise_byte_analysis()